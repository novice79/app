name: build-release

on:
  push:
    branches: [ "**" ]

jobs:
  build_app_release:
    name: Build app release and upload assets
    runs-on: ubuntu-latest
    container:
      # image: novice/build:latest
      image: ubuntu:latest
    steps:
      - name: Set release tag env
        run: |
          BRANCH=${GITHUB_REF##*/}
          TAG="v1.0-$BRANCH"
          echo "TagName=$TAG" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "::notice::TagName=$TAG"
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build app and zip it
        run: |
          # ./pack.sh ${{ env.BRANCH }}
          echo "hello world and BRANCH=$BRANCH" > test.txt
      - name: Upload linux build assets
        run: |
          type -p curl >/dev/null || (apt update && apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && apt update \
          && apt install gh -y
          BRANCH=${GITHUB_REF##*/}
          gh release create v1.0-$BRANCH --notes "test release" ./*.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # with:
        #   body: |
        #     Auto build app for
        #     - macos_aarch64
        #     - macos_x64
        #     - linux_armv7
        #     - linux_aarch64
        #     - linux_x86_64
        #   # file: ${{ github.workspace }}/*.7z
        #   file: test.txt
        #   tag_name: ${{ env.TagName }}
        #   # overwrite: true
        #   # file_glob: true
