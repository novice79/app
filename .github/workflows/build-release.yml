name: build-release

on:
  push:
    branches: [ "**" ]

jobs:
  build_app_release:
    name: Build app release and upload assets
    runs-on: ubuntu-latest
    container:
      image: novice/build:latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set release tag env
        run: |
          BRANCH=${GITHUB_REF##*/}
          TAG="v1.0-$BRANCH"
          echo "TagName=$TAG" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "::notice::TagName=$TAG"
      - name: Build app and zip it
        run: ./pack.sh ${{ env.BRANCH }}
      - name: Upload linux build assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Auto build app for
            - macos_aarch64
            - macos_x64
            - linux_armv7
            - linux_aarch64
            - linux_x86_64
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/*.7z
          tag: ${{ env.TagName }}
          overwrite: true
          file_glob: true
